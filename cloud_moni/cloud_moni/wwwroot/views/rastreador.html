<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cloud Moni - Rastreador de Gastos</title>
    <!-- Incluir Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: Georgia, sans-serif;
            background: url('ruta_de_tu_imagen') no-repeat center center;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .form-container {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0px 3px 7px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        h1 {
            font-family: 'Courier New', Courier, monospace;
            margin-bottom: 20px;
        }

        input, select, button, a {
            display: block;
            box-sizing: border-box;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        button, a {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
        }

            .input-group span {
                font-size: 16px;
                padding: 8px 10px;
                background-color: #f0f0f0;
                border-right: 1px solid #ccc;
            }

            .input-group input {
                border: none;
                outline: none;
                width: 100%;
                padding: 10px;
                font-size: 16px;
            }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

            button:hover {
                background-color: #0056b3;
            }

        .cancel-btn {
            background-color: #6c757d;
        }

            .cancel-btn:hover {
                background-color: #5a6268;
            }

        .tabla-container {
            max-height: 95dvh;
            overflow: auto;
            margin: 10px;
        }

        body {
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>Rastreador de Gastos</h1>
        <form id="formGastos">
            <select name="categoria" id="categoria" required>
                <option value="" disabled selected>Selecciona una categoría</option>
                <option value="recibo_luz">Recibo de Luz</option>
                <option value="recibo_agua">Recibo de Agua</option>
                <option value="linea_telefono">Línea de Teléfono</option>
                <option value="gastos_personales">Gastos Personales</option>
                <option value="utiles_escolares">Útiles Escolares</option>
                <option value="articulos_higiene">Artículos de Higiene</option>
            </select>
            <input type="date" name="fecha" id="fecha" required>
            <input type="text" name="concepto" id="concepto" placeholder="Concepto" required>
            <input type="text" name="total" id="total" placeholder="0.00" required>
            <button type="submit">Guardar</button>
        </form>
    </div>

    <div class="tabla-container">
        <table id="tablaGastos" class="table table-striped mt-4">
            <thead>
                <tr>
                    <th>Categoría</th>
                    <th>Fecha</th>
                    <th>Concepto</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Filas dinámicas -->
            </tbody>
        </table>

    </div>

    <!-- Modal para editar gasto -->
    <div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarLabel">Editar Gasto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarGasto">
                        <select name="categoria" id="categoriaEditar" required>
                            <option value="" disabled selected>Selecciona una categoría</option>
                            <option value="recibo_luz">Recibo de Luz</option>
                            <option value="recibo_agua">Recibo de Agua</option>
                            <option value="linea_telefono">Línea de Teléfono</option>
                            <option value="gastos_personales">Gastos Personales</option>
                            <option value="utiles_escolares">Útiles Escolares</option>
                            <option value="articulos_higiene">Artículos de Higiene</option>
                        </select>
                        <input type="date" name="fecha" id="fechaEditar" class="form-control mb-3" required>
                        <input type="text" name="concepto" id="conceptoEditar" class="form-control mb-3" placeholder="Concepto" required>
                        <input type="text" name="total" id="totalEditar" class="form-control mb-3" placeholder="0.00" required>
                        <button type="submit" class="btn btn-primary">Actualizar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Incluir Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const apiUrl = 'https://localhost:7081/api/Gastos';
        const idUsuario = localStorage.getItem('idUsuario');

        // Cargar gastos al inicio
        const cargarGastos = async () => {
            const response = await fetch(`${apiUrl}/usuario/${idUsuario}`);
            const gastos = await response.json();

            const tabla = document.getElementById('tablaGastos').querySelector('tbody');
            tabla.innerHTML = '';

            gastos.forEach(gasto => {
                const fila = `<tr>
                                <td>${gasto.categoria}</td>
                                <td>${new Date(gasto.fecha).toISOString().split('T')[0]}</td>
                                <td>${gasto.concepto}</td>
                                <td>${gasto.total}</td>
                                <td>
                                    <button class="btn btn-warning" onclick="editarGasto(${gasto.idGasto})">Editar</button>
                                    <button class="btn btn-danger" onclick="eliminarGasto(${gasto.idGasto})">Eliminar</button>
                                </td>
                            </tr>`;
                tabla.innerHTML += fila;
            });
        };

        // Editar gasto
        const editarGasto = (idGasto) => {
            fetch(`${apiUrl}/${idGasto}`)
                .then(response => response.json())
                .then(gasto => {
                    const fechaSolo = new Date(gasto.fecha).toISOString().split('T')[0];
                    document.getElementById('categoriaEditar').value = gasto.categoria;
                    document.getElementById('fechaEditar').value = fechaSolo;
                    document.getElementById('conceptoEditar').value = gasto.concepto;
                    document.getElementById('totalEditar').value = gasto.total;

                    // Mostrar el modal de edición
                    const modal = new bootstrap.Modal(document.getElementById('modalEditar'));
                    modal.show();

                    // Actualizar el gasto
                    document.getElementById('formEditarGasto').onsubmit = async (event) => {
                        event.preventDefault();
                        const actualizado = {
                            idGasto,
                            idUsuario,
                            categoria: document.getElementById('categoriaEditar').value,
                            fecha: document.getElementById('fechaEditar').value,
                            concepto: document.getElementById('conceptoEditar').value,
                            total: parseFloat(document.getElementById('totalEditar').value.replace(',', ''))
                        };

                        await fetch(`${apiUrl}/${idGasto}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(actualizado)
                        });
                        cargarGastos();
                        modal.hide();
                    };
                });
        };

        // Eliminar gasto
        const eliminarGasto = (idGasto) => {
            if (window.confirm('¿Estás seguro de que quieres eliminar este gasto?')) {
                fetch(`${apiUrl}/${idGasto}`, { method: 'DELETE' })
                    .then(() => {
                        cargarGastos();
                    });
            }
        };

        // Agregar nuevo gasto
        document.getElementById('formGastos').onsubmit = async (event) => {
            event.preventDefault();

            const nuevoGasto = {
                idUsuario,
                categoria: document.getElementById('categoria').value,
                fecha: document.getElementById('fecha').value,
                concepto: document.getElementById('concepto').value,
                total: parseFloat(document.getElementById('total').value.replace(',', ''))
            };

            await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(nuevoGasto)
            });

            document.getElementById('formGastos').reset();

            cargarGastos();
        };

        // Cargar los gastos al iniciar
        cargarGastos();
    </script>
</body>
</html>
